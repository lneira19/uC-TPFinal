/***************************************************************************//**
  @file     drv_sw.c
  @brief    Driver para uso de switch
  @author   Lucas Matias Neira
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/

#include "drv_sw.h"
#include "gpio.h"
#include "board.h"
#include "timer.h"

/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/


/*******************************************************************************
 * ENUMERATIONS AND STRUCTURES AND TYPEDEFS
 ******************************************************************************/

/*******************************************************************************
 * VARIABLES WITH GLOBAL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS WITH FILE LEVEL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * ROM CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

/*******************************************************************************
 * STATIC VARIABLES AND CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/
static uint8_t state_sw;
static uint8_t state_RP;
static ticks_t time_RP;

/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/
void drvSWInit(void)
{
    state_sw = !ON;
    state_RP = !RP_ON;
    time_RP = RP_PERIOD;
}


uint8_t readSwitchState(int pin)
{
    uint8_t state_sw;
    state_sw = (gpioRead(pin) == SWITCH_ACTIVE)? ON : !ON;
    return state_sw;
}

void executeOnSwitchChange(int pin, void (*ptr)(void))
{
    state_sw = readSwitchState(pin);

    if (state_sw) // Si es que se detecta la activación del SW
    {
        if (state_RP == !RP_ON) // Si es que NO hay Período Refractario (RP) activado (OFF)
        {
            // Inicio del período refractario ...
            state_RP = RP_ON;
            time_RP = timerStart(RP_PERIOD);

            // Ejecución de la función pasada por puntero ...
            ptr();
        }
    }

    if (timerExpired(time_RP))
    {
        state_RP = !RP_ON;
    }
}

/*******************************************************************************
 *******************************************************************************
                        LOCAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/


/******************************************************************************/
